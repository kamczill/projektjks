{"version":3,"file":"delete.js","names":["wpActionDELETE","helpers","wpAction","reporter","actions","getNode","cachedNodeIds","getPersistentCache","key","CREATED_NODE_IDS","nodeId","referencedNodeGlobalRelayID","node","typeInfo","getQueryInfoBySingleFieldName","referencedNodeSingularName","info","formatLogMessage","log","typeSettings","getTypeSettingsByType","name","nodesTypeName","beforeChangeNode","additionalNodeIds","actionType","remoteNode","fetchGraphql","buildTypeName","wpStore","store","length","forEach","id","push","touchNode","deleteNode","chalk","bold","title","referencedNodeID","validNodeIds","filter","cachedId","setPersistentCache","value","e","Object","entries","warn","JSON","stringify","Error","module","exports"],"sources":["../../../../../src/steps/source-nodes/update-nodes/wp-actions/delete.js"],"sourcesContent":["import chalk from \"chalk\"\n\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport store from \"~/store\"\nimport {\n  getTypeSettingsByType,\n  buildTypeName,\n} from \"~/steps/create-schema-customization/helpers\"\nimport { fetchGraphql } from \"~/utils/fetch-graphql\"\nimport { getQueryInfoBySingleFieldName } from \"../../helpers\"\nimport { CREATED_NODE_IDS } from \"~/constants\"\nimport { setPersistentCache, getPersistentCache } from \"~/utils/cache\"\n\nconst wpActionDELETE = async ({\n  helpers,\n  // cachedNodeIds,\n  wpAction,\n}) => {\n  const { reporter, actions, getNode } = helpers\n\n  try {\n    const cachedNodeIds = await getPersistentCache({ key: CREATED_NODE_IDS })\n\n    // get the node ID from the WPGQL id\n    const nodeId = wpAction.referencedNodeGlobalRelayID\n\n    const node = await getNode(nodeId)\n\n    const { typeInfo } =\n      getQueryInfoBySingleFieldName(wpAction.referencedNodeSingularName) || {}\n\n    if (!typeInfo) {\n      reporter.info(\n        formatLogMessage(\n          `A ${wpAction.referencedNodeSingularName} was deleted, but this node type is excluded in plugin options.`\n        )\n      )\n      reporter.log(``)\n      return\n    }\n\n    const typeSettings = getTypeSettingsByType({\n      name: typeInfo.nodesTypeName,\n    })\n\n    if (\n      typeSettings.beforeChangeNode &&\n      typeof typeSettings.beforeChangeNode === `function`\n    ) {\n      const { additionalNodeIds } =\n        (await typeSettings.beforeChangeNode({\n          actionType: `DELETE`,\n          remoteNode: node,\n          actions,\n          helpers,\n          typeInfo,\n          fetchGraphql,\n          typeSettings,\n          buildTypeName,\n          wpStore: store,\n        })) || {}\n\n      if (additionalNodeIds && additionalNodeIds.length) {\n        additionalNodeIds.forEach(id => cachedNodeIds.push(id))\n      }\n    }\n\n    if (node) {\n      await actions.touchNode(node)\n      await actions.deleteNode(node)\n\n      reporter.log(``)\n      reporter.info(\n        formatLogMessage(\n          `${chalk.bold(`deleted ${wpAction.referencedNodeSingularName}`)} ${\n            wpAction.title\n          } (#${wpAction.referencedNodeID})`\n        )\n      )\n\n      reporter.log(``)\n    }\n\n    // Remove this from cached node id's so we don't try to touch it\n    const validNodeIds = cachedNodeIds.filter(cachedId => cachedId !== nodeId)\n\n    await setPersistentCache({ key: CREATED_NODE_IDS, value: validNodeIds })\n\n    // return validNodeIds\n  } catch (e) {\n    Object.entries(wpAction).forEach(([key, value]) => {\n      reporter.warn(`${key} ${JSON.stringify(value)}`)\n    })\n    throw Error(e)\n  }\n}\n\nmodule.exports = wpActionDELETE\n"],"mappings":"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"}