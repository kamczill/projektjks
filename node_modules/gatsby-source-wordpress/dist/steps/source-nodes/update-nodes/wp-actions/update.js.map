{"version":3,"file":"update.js","names":["fetchAndCreateSingleNode","singleName","id","actionType","cachedNodeIds","token","isPreview","isDraft","userDatabaseId","getNodeQuery","nodeQuery","previewQuery","getQueryInfoBySingleFieldName","query","helpers","reporter","getNode","pluginOptions","getGatsbyApi","info","formatLogMessage","node","headers","WPGatsbyPreview","WPGatsbyPreviewUser","data","fetchGraphql","variables","errorContext","remoteNode","warn","uri","normalizeUri","slug","existingNode","databaseId","date","dateGmt","guid","link","status","additionalNodeIds","createSingleNode","debug","preview","dump","state","store","getState","gatsbyApi","wpUrl","remoteSchema","typeInfo","getPersistentCache","key","CREATED_NODE_IDS","updatedNodeContent","nodeType","nodesTypeName","type","processedNode","nodeMediaItemIdReferences","processNode","fetchReferencedMediaItemsAndCreateNodes","referencedMediaItemNodeIds","actions","createContentDigest","builtTypename","buildTypeName","addImageCDNFieldsToNode","__typename","parent","internal","contentDigest","typeSettings","getTypeSettingsByType","name","cancelUpdate","beforeChangeNode","receivedAdditionalNodeIds","receivedRemoteNode","receivedCancelUpdate","wpStore","createNode","push","length","forEach","setPersistentCache","value","wpActionUPDATE","wpAction","reportUpdate","setAction","log","chalk","bold","toLowerCase","referencedNodeSingularName","title","referencedNodeID","verbose","nodeId","referencedNodeGlobalRelayID","referencedNodeStatus","validNodeIds","filter","cachedId","touchNode","deleteNode","nodeEntries","Object","entries","loggableEntries","includes","italic","getDbIdFromRelayId","relayId","atob","split","reverse","replace","endsWith","slice","startsWith","dbId"],"sources":["../../../../../src/steps/source-nodes/update-nodes/wp-actions/update.js"],"sourcesContent":["import fetchGraphql from \"~/utils/fetch-graphql\"\nimport store from \"~/store\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport chalk from \"chalk\"\nimport { getQueryInfoBySingleFieldName } from \"../../helpers\"\nimport { getGatsbyApi } from \"~/utils/get-gatsby-api\"\nimport { CREATED_NODE_IDS } from \"~/constants\"\nimport fetchReferencedMediaItemsAndCreateNodes, {\n  addImageCDNFieldsToNode,\n} from \"../../fetch-nodes/fetch-referenced-media-items\"\n\nimport { dump } from \"dumper.js\"\nimport { atob } from \"atob\"\nimport { camelCase } from \"lodash\"\n\nimport {\n  buildTypeName,\n  getTypeSettingsByType,\n} from \"~/steps/create-schema-customization/helpers\"\nimport { processNode } from \"~/steps/source-nodes/create-nodes/process-node\"\nimport { getPersistentCache, setPersistentCache } from \"~/utils/cache\"\n\nexport const fetchAndCreateSingleNode = async ({\n  singleName,\n  id,\n  actionType,\n  cachedNodeIds,\n  token = null,\n  isPreview = false,\n  isDraft = false,\n  userDatabaseId = null,\n}) => {\n  function getNodeQuery() {\n    const { nodeQuery, previewQuery } =\n      getQueryInfoBySingleFieldName(singleName) || {}\n\n    // if this is a preview use the preview query\n    // if it's a preview but it's the initial blank node\n    // then use the regular node query as the preview query wont\n    // return anything\n    const query = isPreview && !isDraft ? previewQuery : nodeQuery\n\n    return query\n  }\n\n  const query = getNodeQuery()\n\n  const {\n    helpers: { reporter, getNode },\n    pluginOptions,\n  } = getGatsbyApi()\n\n  if (!query) {\n    reporter.info(\n      formatLogMessage(\n        `A ${singleName} was updated, but no query was found for this node type. This node type is either excluded in plugin options or this is a bug.`\n      )\n    )\n    return { node: null }\n  }\n\n  const headers =\n    token && userDatabaseId\n      ? {\n          WPGatsbyPreview: token,\n          WPGatsbyPreviewUser: userDatabaseId,\n        }\n      : {}\n\n  const { data } = await fetchGraphql({\n    headers,\n    query,\n    variables: {\n      id,\n    },\n    errorContext: `Error occurred while updating a single \"${singleName}\" node.`,\n  })\n\n  let remoteNode = data[singleName] || data[camelCase(singleName)]\n\n  if (!data || !remoteNode) {\n    reporter.warn(\n      formatLogMessage(\n        `${id} ${singleName} was updated, but no data was returned for this node.`\n      )\n    )\n\n    reporter.info({\n      singleName,\n      id,\n      actionType,\n      cachedNodeIds,\n      token,\n      isPreview,\n      userDatabaseId,\n    })\n\n    return { node: null }\n  }\n\n  remoteNode.uri = normalizeUri({\n    uri: remoteNode.uri,\n    singleName,\n    id,\n  })\n\n  if (isPreview && `slug` in remoteNode && !remoteNode.slug) {\n    // sometimes preview nodes do not have a slug - but some users will use slugs to build page urls. So we should make sure we have something for the slug.\n    remoteNode.slug = id\n  }\n\n  if (isPreview) {\n    const existingNode = getNode(id)\n\n    /**\n     * For Preview, revisions of a node type can have data that updates unecessarily\n     * This code block fixes that. The result being that less queries\n     * are invalidated in Gatsby. For example if you have a query where you're getting the latest published post using the date field, that should be static but each preview updates the date field on the node being previewed (because the revision has a new date). So if we prevent the following fields from changing, this will be less problematic.\n     */\n    if (existingNode) {\n      remoteNode = {\n        ...remoteNode,\n        databaseId: existingNode.databaseId,\n        date: existingNode.date,\n        dateGmt: existingNode.dateGmt,\n        slug: existingNode.slug,\n        guid: existingNode.guid,\n        id: existingNode.id,\n        link: existingNode.link,\n        uri: existingNode.uri,\n        status: existingNode.status,\n      }\n    }\n  }\n\n  data[singleName] = remoteNode\n\n  const { additionalNodeIds, node } = await createSingleNode({\n    singleName,\n    id,\n    actionType,\n    data,\n    cachedNodeIds,\n  })\n\n  if (isPreview) {\n    reporter.info(\n      formatLogMessage(`Preview for ${singleName} ${node.id} was updated.`)\n    )\n\n    if (pluginOptions.debug.preview) {\n      reporter.info(formatLogMessage(`Raw remote node data:`))\n      dump(data)\n    }\n  }\n\n  return { node, additionalNodeIds }\n}\n\nexport const createSingleNode = async ({\n  singleName,\n  id,\n  actionType,\n  data,\n  cachedNodeIds,\n}) => {\n  const state = store.getState()\n  const { helpers, pluginOptions } = state.gatsbyApi\n  const { wpUrl } = state.remoteSchema\n\n  const { typeInfo } = getQueryInfoBySingleFieldName(singleName)\n\n  if (!cachedNodeIds) {\n    cachedNodeIds = await getPersistentCache({ key: CREATED_NODE_IDS })\n  }\n\n  const updatedNodeContent = {\n    ...data[singleName],\n    nodeType: typeInfo.nodesTypeName,\n    type: typeInfo.nodesTypeName,\n  }\n\n  const { processedNode, nodeMediaItemIdReferences } = await processNode({\n    node: updatedNodeContent,\n    pluginOptions,\n    wpUrl,\n    helpers,\n  })\n\n  await fetchReferencedMediaItemsAndCreateNodes({\n    referencedMediaItemNodeIds: nodeMediaItemIdReferences,\n  })\n\n  const { actions } = helpers\n\n  const { createContentDigest } = helpers\n\n  const builtTypename = buildTypeName(typeInfo.nodesTypeName)\n\n  let remoteNode = addImageCDNFieldsToNode(\n    {\n      ...processedNode,\n      __typename: builtTypename,\n      id: id,\n      parent: null,\n      internal: {\n        contentDigest: createContentDigest(updatedNodeContent),\n        type: builtTypename,\n      },\n    },\n    pluginOptions\n  )\n\n  const typeSettings = getTypeSettingsByType({\n    name: typeInfo.nodesTypeName,\n  })\n\n  let additionalNodeIds = nodeMediaItemIdReferences || []\n  let cancelUpdate\n\n  if (\n    typeSettings.beforeChangeNode &&\n    typeof typeSettings.beforeChangeNode === `function`\n  ) {\n    const {\n      additionalNodeIds: receivedAdditionalNodeIds,\n      remoteNode: receivedRemoteNode,\n      cancelUpdate: receivedCancelUpdate,\n    } = (await typeSettings.beforeChangeNode({\n      actionType: actionType,\n      remoteNode,\n      actions,\n      helpers,\n      fetchGraphql,\n      typeSettings,\n      buildTypeName,\n      type: typeInfo.nodesTypeName,\n      wpStore: store,\n    })) || {}\n\n    additionalNodeIds = [\n      ...additionalNodeIds,\n      ...(receivedAdditionalNodeIds || []),\n    ]\n\n    cancelUpdate = receivedCancelUpdate\n\n    if (receivedRemoteNode) {\n      remoteNode = receivedRemoteNode\n    }\n  }\n\n  if (cancelUpdate) {\n    return {\n      additionalNodeIds,\n      remoteNode: null,\n    }\n  }\n\n  if (remoteNode) {\n    actions.createNode(remoteNode)\n\n    cachedNodeIds.push(remoteNode.id)\n\n    if (additionalNodeIds && additionalNodeIds.length) {\n      additionalNodeIds.forEach(id => cachedNodeIds.push(id))\n    }\n\n    await setPersistentCache({ key: CREATED_NODE_IDS, value: cachedNodeIds })\n  }\n\n  return { additionalNodeIds, node: remoteNode }\n}\n\nconst wpActionUPDATE = async ({ helpers, wpAction }) => {\n  const reportUpdate = ({ setAction } = {}) => {\n    const actionType = setAction || wpAction.actionType\n\n    reporter.log(``)\n    reporter.info(\n      formatLogMessage(\n        `${chalk.bold(\n          `${actionType.toLowerCase()} ${wpAction.referencedNodeSingularName}`\n        )} ${wpAction.title} (#${wpAction.referencedNodeID})`\n      )\n    )\n    reporter.log(``)\n  }\n\n  const { reporter, actions } = helpers\n\n  const cachedNodeIds = await getPersistentCache({ key: CREATED_NODE_IDS })\n\n  const state = store.getState()\n  const {\n    gatsbyApi: {\n      pluginOptions: { verbose },\n      helpers: { getNode },\n    },\n  } = state\n\n  const nodeId = wpAction.referencedNodeGlobalRelayID\n\n  const existingNode = await getNode(nodeId)\n\n  if (wpAction.referencedNodeStatus !== `publish`) {\n    // if the post status isn't publish anymore, we need to remove the node\n    // by removing it from cached nodes so it's garbage collected by Gatsby\n    const validNodeIds = cachedNodeIds.filter(cachedId => cachedId !== nodeId)\n\n    await setPersistentCache({ key: CREATED_NODE_IDS, value: validNodeIds })\n\n    if (existingNode) {\n      await actions.touchNode(existingNode)\n      await actions.deleteNode(existingNode)\n      reportUpdate({ setAction: `DELETE` })\n    }\n\n    return\n  }\n\n  const { node } = await fetchAndCreateSingleNode({\n    id: nodeId,\n    actionType: wpAction.actionType,\n    singleName: wpAction.referencedNodeSingularName,\n    cachedNodeIds,\n  })\n\n  if (node) {\n    reportUpdate()\n\n    if (verbose) {\n      const nodeEntries = existingNode ? Object.entries(existingNode) : null\n\n      if (nodeEntries?.length) {\n        const loggableEntries = nodeEntries.filter(\n          ([key]) => !key.includes(`modifiedGmt`) && key !== `modified`\n        )\n\n        for (const [key, value] of loggableEntries) {\n          if (!node || !node[key] || !value) {\n            return\n          }\n\n          if (\n            // if the value of this field changed, log it\n            typeof node[key] === `string` &&\n            value !== node[key]\n          ) {\n            reporter.log(``)\n            reporter.info(chalk.bold(`${key} changed`))\n\n            if (value.length < 250 && node[key].length < 250) {\n              reporter.log(``)\n              reporter.log(`${chalk.italic.bold(`    from`)}`)\n              reporter.log(`      ${value}`)\n              reporter.log(chalk.italic.bold(`    to`))\n              reporter.log(`      ${node[key]}`)\n              reporter.log(``)\n            }\n          }\n        }\n\n        reporter.log(``)\n      }\n    }\n  }\n\n  // return cachedNodeIds\n}\n\nconst getDbIdFromRelayId = relayId => atob(relayId).split(`:`).reverse()[0]\n\nconst normalizeUri = ({ uri, id, singleName }) => {\n  // remove the preview query params as they're not relevant in Gatsby\n  uri = uri?.replace(`preview=true`, ``)\n\n  // if removing the preview string leaves us with either of these\n  // characters at the end, trim em off!\n  if (uri?.endsWith(`?`) || uri?.endsWith(`&`)) {\n    uri = uri.slice(0, -1)\n  }\n\n  // if this is a draft url which could look like\n  // this /?p=543534 or /?page=4324 or /?something=yep&page=543543 or /?p=4534&what=yes\n  // we will create a proper path that Gatsby can handle\n  // /post_graphql_name/post_db_id/\n  // this same logic is on the WP side in the preview template\n  // to account for this situation.\n  if (uri?.startsWith(`/?`)) {\n    const dbId = getDbIdFromRelayId(id)\n\n    return `/generated-preview-path/${singleName}/${dbId}/`\n  }\n\n  return uri\n}\n\nexport default wpActionUPDATE\n"],"mappings":"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"}