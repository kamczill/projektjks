{"version":3,"file":"create-nodes.js","names":["createNodesQueue","PQueue","concurrency","createNodeWithSideEffects","node","state","wpgqlNodesGroup","referencedMediaItemNodeIds","Set","createdNodeIds","createNodesActivity","totalSideEffectNodes","type","wpUrl","remoteSchema","helpers","pluginOptions","gatsbyApi","actions","createContentDigest","link","path","urlToPath","plural","processedNode","processNode","builtTypename","buildTypeName","__typename","remoteNode","id","parent","internal","contentDigest","typeSettings","getTypeSettingsByType","name","beforeChangeNode","additionalNodeIds","changedRemoteNode","actionType","fetchGraphql","wpStore","store","length","forEach","push","setStatus","createNode","createGatsbyNodesFromWPGQLContentNodes","wpgqlNodesByContentType","getState","reporter","dispatch","logger","createActivityTimer","typeName","wpgqlNodes","allNodesOfContentType","values","add","onIdle","referencedMediaItemNodeIdsArray","MediaItem","exclude","lazyNodes","usingGatsbyV4OrGreater","fetchReferencedMediaItemsAndCreateNodes","stopActivityTimer"],"sources":["../../../../src/steps/source-nodes/create-nodes/create-nodes.js"],"sourcesContent":["import PQueue from \"p-queue\"\nimport fetchReferencedMediaItemsAndCreateNodes from \"../fetch-nodes/fetch-referenced-media-items\"\nimport urlToPath from \"~/utils/url-to-path\"\nimport store from \"~/store\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport { usingGatsbyV4OrGreater } from \"~/utils/gatsby-version\"\n\nimport {\n  buildTypeName,\n  getTypeSettingsByType,\n} from \"~/steps/create-schema-customization/helpers\"\nimport { processNode } from \"./process-node\"\n\n// @todo concurrency is currently set so low because side effects can overwhelm\n// the remote server. A queue for the entire source plugin should be created so that\n// everything can share a queue and we can speed some of these things up\nconst createNodesQueue = new PQueue({\n  concurrency: 2,\n})\n\nexport const createNodeWithSideEffects =\n  ({\n    node,\n    state,\n    wpgqlNodesGroup = null,\n    referencedMediaItemNodeIds = new Set(),\n    createdNodeIds = [],\n    createNodesActivity = null,\n    totalSideEffectNodes = null,\n    type = null,\n  }) =>\n  async () => {\n    const { wpUrl } = state.remoteSchema\n    const { helpers, pluginOptions } = state.gatsbyApi\n\n    const { actions, createContentDigest } = helpers\n\n    if (node.link) {\n      // @todo is this still necessary? I don't think it is but double check\n      // create a pathname for the node using the WP permalink\n      node.path = urlToPath(node.link)\n    }\n\n    if (wpgqlNodesGroup?.plural !== `mediaItems`) {\n      const { processedNode } = await processNode({\n        node,\n        pluginOptions,\n        referencedMediaItemNodeIds,\n        wpUrl,\n        helpers,\n      })\n\n      node = processedNode\n    }\n\n    const builtTypename = buildTypeName(node.__typename)\n\n    let remoteNode = {\n      ...node,\n      __typename: builtTypename,\n      id: node.id,\n      parent: null,\n      internal: {\n        contentDigest: createContentDigest(node),\n        type: type || builtTypename,\n      },\n    }\n\n    const typeSettings = getTypeSettingsByType({\n      name: node.type,\n    })\n\n    if (typeof typeSettings?.beforeChangeNode === `function`) {\n      const { additionalNodeIds, remoteNode: changedRemoteNode } =\n        (await typeSettings.beforeChangeNode({\n          actionType: `CREATE_ALL`,\n          remoteNode,\n          actions,\n          helpers,\n          type: node.type,\n          fetchGraphql,\n          typeSettings,\n          buildTypeName,\n          wpStore: store,\n        })) || {}\n\n      if (changedRemoteNode) {\n        remoteNode = changedRemoteNode\n      }\n\n      if (additionalNodeIds?.length && totalSideEffectNodes) {\n        additionalNodeIds.forEach(\n          id => createdNodeIds.push(id) && totalSideEffectNodes.push(id)\n        )\n      }\n\n      if (\n        totalSideEffectNodes &&\n        typeof totalSideEffectNodes?.length === `number` &&\n        totalSideEffectNodes.length > 0 &&\n        createNodesActivity\n      ) {\n        createNodesActivity.setStatus(\n          `awaiting async side effects - ${totalSideEffectNodes.length} additional nodes fetched`\n        )\n      }\n    }\n\n    await actions.createNode(remoteNode)\n\n    createdNodeIds.push(node.id)\n  }\n\nexport const createGatsbyNodesFromWPGQLContentNodes = async ({\n  wpgqlNodesByContentType,\n  createNodesActivity,\n}) => {\n  const state = store.getState()\n  const { helpers, pluginOptions } = state.gatsbyApi\n\n  const { reporter } = helpers\n\n  // wp supports these file extensions\n  // jpeg|jpg|png|gif|ico|pdf|doc|docx|ppt|pptx|pps|ppsx|odt|xls|psd|mp3|m4a|ogg|wav|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2|svg|bmp|tif|tiff|asf|asx|wm|wmx|divx|flv|qt|mpe|webm|mkv|txt|asc|c|cc|h|csv|tsv|ics|rtx|css|htm|html|m4b|ra|ram|mid|midi|wax|mka|rtf|js|swf|class|tar|zip|gz|gzip|rar|7z|exe|pot|wri|xla|xlt|xlw|mdb|mpp|docm|dotx|dotm|xlsm|xlsb|xltx|xltm|xlam|pptm|ppsm|potx|potm|ppam|sldx|sldm|onetoc|onetoc2|onetmp|onepkg|odp|ods|odg|odc|odb|odf|wp|wpd|key|numbers|pages\n\n  // gatsby-image supports these file types\n  // const imgSrcRemoteFileRegex = /<img.*?src=\\\\\"(.*?jpeg|jpg|png|webp|tif|tiff$)\\\\\"[^>]+>/gim\n\n  store.dispatch.logger.createActivityTimer({\n    typeName: `MediaItem`,\n    pluginOptions,\n    reporter,\n  })\n\n  const createdNodeIds = []\n  const totalSideEffectNodes = []\n  const referencedMediaItemNodeIds = new Set()\n\n  for (const wpgqlNodesGroup of wpgqlNodesByContentType) {\n    const wpgqlNodes = wpgqlNodesGroup.allNodesOfContentType\n\n    for (const node of wpgqlNodes.values()) {\n      createNodesQueue.add(\n        createNodeWithSideEffects({\n          state,\n          node,\n          wpgqlNodesGroup,\n          referencedMediaItemNodeIds,\n          createdNodeIds,\n          createNodesActivity,\n          totalSideEffectNodes,\n        })\n      )\n    }\n  }\n\n  await createNodesQueue.onIdle()\n\n  const referencedMediaItemNodeIdsArray = [...referencedMediaItemNodeIds]\n\n  /**\n   * if we're not excluding media items or we're lazy fetching media items (before Gatsby v4), we need to fetch media item nodes upfront here\n   */\n  if (\n    !pluginOptions.type.MediaItem.exclude &&\n    (!pluginOptions.type.MediaItem.lazyNodes || usingGatsbyV4OrGreater) &&\n    referencedMediaItemNodeIdsArray.length\n  ) {\n    await fetchReferencedMediaItemsAndCreateNodes({\n      referencedMediaItemNodeIds: referencedMediaItemNodeIdsArray,\n    })\n\n    store.dispatch.logger.stopActivityTimer({\n      typeName: `MediaItem`,\n    })\n\n    return [...createdNodeIds, ...referencedMediaItemNodeIdsArray]\n  }\n\n  store.dispatch.logger.stopActivityTimer({\n    typeName: `MediaItem`,\n  })\n\n  return createdNodeIds\n}\n"],"mappings":"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"}