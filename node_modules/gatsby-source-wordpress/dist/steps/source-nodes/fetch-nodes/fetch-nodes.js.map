{"version":3,"file":"fetch-nodes.js","names":["fetchWPGQLContentNodes","queryInfo","pluginOptions","helpers","store","getState","gatsbyApi","reporter","url","schema","perPage","nodeListQueries","typeInfo","settings","typeName","nodesTypeName","dispatch","logger","createActivityTimer","allNodesOfContentType","nodeListQuery","contentNodes","paginatedWpNodeFetch","first","after","contentTypePlural","pluralName","nodeTypeName","query","stopActivityTimer","length","singular","singularName","plural","getContentTypeQueryInfos","nodeQueries","remoteSchema","queryInfos","Object","values","filter","exclude","cachedGatsbyNodeTypeNames","getGatsbyNodeTypeNames","typeMap","queryableTypenames","map","implementingNodeTypes","reduce","accumulator","typename","type","get","possibleTypes","name","allTypeNames","Set","allBuiltTypeNames","buildTypeName","typeNameList","runFnForEachNodeQuery","fn","chunkSize","getPluginOptions","requestConcurrency","chunkedQueries","chunk","queries","Promise","all","lazyNodes","usingGatsbyV4OrGreater","fetchWPGQLContentNodesByContentType","contentNodeGroups","contentNodeGroup","push","fetchAndCreateAllNodes","getGatsbyApi","activity","activityTimer","formatLogMessage","start","subscribe","setStatus","entityCount","createdNodeIds","hardCachedNodes","getHardCachedNodes","wpgqlNodesByContentType","createNodesActivity","createGatsbyNodesFromWPGQLContentNodes","setHardCachedNodes","end","restoreHardCachedNodes","setPersistentCache","key","CREATED_NODE_IDS","value"],"sources":["../../../../src/steps/source-nodes/fetch-nodes/fetch-nodes.js"],"sourcesContent":["import { createGatsbyNodesFromWPGQLContentNodes } from \"../create-nodes/create-nodes\"\nimport { paginatedWpNodeFetch } from \"./fetch-nodes-paginated\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { CREATED_NODE_IDS } from \"~/constants\"\nimport { usingGatsbyV4OrGreater } from \"~/utils/gatsby-version\"\n\nimport store from \"~/store\"\nimport { getGatsbyApi, getPluginOptions } from \"~/utils/get-gatsby-api\"\nimport chunk from \"lodash/chunk\"\n\nimport {\n  getHardCachedNodes,\n  restoreHardCachedNodes,\n  setHardCachedNodes,\n  setPersistentCache,\n} from \"~/utils/cache\"\nimport { buildTypeName } from \"../../create-schema-customization/helpers\"\n\n/**\n * fetchWPGQLContentNodes\n *\n * fetches and paginates remote nodes by post type while reporting progress\n */\nexport const fetchWPGQLContentNodes = async ({ queryInfo }) => {\n  const { pluginOptions, helpers } = store.getState().gatsbyApi\n  const { reporter } = helpers\n  const {\n    url,\n    schema: { perPage },\n  } = pluginOptions\n\n  const { nodeListQueries, typeInfo, settings } = queryInfo\n\n  const typeName = typeInfo.nodesTypeName\n\n  store.dispatch.logger.createActivityTimer({\n    typeName,\n    pluginOptions,\n    reporter,\n  })\n\n  let allNodesOfContentType = []\n\n  // there's normally just one query here, but more can be added using the settings.nodeListQueries api\n  for (const nodeListQuery of nodeListQueries) {\n    const contentNodes = await paginatedWpNodeFetch({\n      first: perPage,\n      after: null,\n      contentTypePlural: typeInfo.pluralName,\n      nodeTypeName: typeInfo.nodesTypeName,\n      query: nodeListQuery,\n      url,\n      settings,\n      helpers,\n    })\n\n    allNodesOfContentType = [...allNodesOfContentType, ...contentNodes]\n  }\n\n  store.dispatch.logger.stopActivityTimer({ typeName })\n\n  if (allNodesOfContentType && allNodesOfContentType.length) {\n    return {\n      singular: queryInfo.typeInfo.singularName,\n      plural: queryInfo.typeInfo.pluralName,\n      allNodesOfContentType,\n    }\n  }\n\n  return false\n}\n\n/**\n * getContentTypeQueryInfos\n *\n * returns query infos (Type info & GQL query strings) filtered to\n * remove types that are excluded in the plugin options\n *\n * @returns {Array} Type info & GQL query strings\n */\nexport const getContentTypeQueryInfos = () => {\n  const { nodeQueries } = store.getState().remoteSchema\n  const queryInfos = Object.values(nodeQueries).filter(\n    ({ settings }) => !settings.exclude\n  )\n  return queryInfos\n}\n\nlet cachedGatsbyNodeTypeNames = null\n\nexport const getGatsbyNodeTypeNames = () => {\n  if (cachedGatsbyNodeTypeNames) {\n    return cachedGatsbyNodeTypeNames\n  }\n\n  const { typeMap } = store.getState().remoteSchema\n\n  const queryableTypenames = getContentTypeQueryInfos().map(\n    query => query.typeInfo.nodesTypeName\n  )\n\n  const implementingNodeTypes = queryableTypenames.reduce(\n    (accumulator, typename) => {\n      const type = typeMap.get(typename)\n\n      if (type.possibleTypes?.length) {\n        accumulator = [\n          ...accumulator,\n          ...type.possibleTypes.map(({ name }) => name),\n        ]\n      }\n\n      return accumulator\n    },\n    []\n  )\n\n  const allTypeNames = [\n    ...new Set([...queryableTypenames, ...implementingNodeTypes]),\n  ]\n\n  const allBuiltTypeNames = allTypeNames.map(typename =>\n    buildTypeName(typename)\n  )\n\n  const typeNameList = [...allTypeNames, ...allBuiltTypeNames]\n\n  if (typeNameList.length) {\n    cachedGatsbyNodeTypeNames = typeNameList\n  }\n\n  return typeNameList\n}\n\n/**\n * fetchWPGQLContentNodesByContentType\n *\n * fetches nodes from the remote WPGQL server and groups them by post type\n *\n * @returns {Array}\n */\nexport const runFnForEachNodeQuery = async fn => {\n  const nodeQueries = getContentTypeQueryInfos()\n\n  const chunkSize = getPluginOptions()?.schema?.requestConcurrency || 15\n  const chunkedQueries = chunk(nodeQueries, chunkSize)\n\n  for (const queries of chunkedQueries) {\n    await Promise.all(\n      queries.map(async queryInfo => {\n        if (\n          // if the type settings call for lazyNodes, don't fetch them upfront here\n          (queryInfo.settings.lazyNodes &&\n            // but not in Gatsby v4+ since lazyNodes isn't supported in 4+\n            !usingGatsbyV4OrGreater) ||\n          // for media items we only want to fetch referenced nodes so don't fetch them here.\n          queryInfo.typeInfo.nodesTypeName === `MediaItem`\n        ) {\n          return\n        }\n\n        await fn({ queryInfo })\n      })\n    )\n  }\n}\n\nexport const fetchWPGQLContentNodesByContentType = async () => {\n  const contentNodeGroups = []\n\n  await runFnForEachNodeQuery(async ({ queryInfo }) => {\n    const contentNodeGroup = await fetchWPGQLContentNodes({ queryInfo })\n\n    if (contentNodeGroup) {\n      contentNodeGroups.push(contentNodeGroup)\n    }\n  })\n\n  return contentNodeGroups\n}\n\n/**\n * fetchAndCreateAllNodes\n *\n * uses query info (generated from introspection in onPreBootstrap) to\n * fetch and create Gatsby nodes from any lists of nodes in the remote schema\n */\nexport const fetchAndCreateAllNodes = async () => {\n  const { helpers } = getGatsbyApi()\n  const { reporter } = helpers\n\n  //\n  // fetch nodes from WPGQL\n  const activity = reporter.activityTimer(formatLogMessage(`fetching nodes`))\n  activity.start()\n\n  store.subscribe(() => {\n    activity.setStatus(`${store.getState().logger.entityCount} total`)\n  })\n\n  let createdNodeIds\n\n  const hardCachedNodes = await getHardCachedNodes()\n\n  if (!hardCachedNodes) {\n    const wpgqlNodesByContentType = await fetchWPGQLContentNodesByContentType()\n\n    const createNodesActivity = reporter.activityTimer(\n      formatLogMessage(`creating nodes`)\n    )\n    createNodesActivity.start()\n\n    //\n    // Create Gatsby nodes from WPGQL response\n    createdNodeIds = await createGatsbyNodesFromWPGQLContentNodes({\n      wpgqlNodesByContentType,\n      createNodesActivity,\n    })\n\n    await setHardCachedNodes({ helpers })\n\n    createNodesActivity.end()\n    activity.end()\n  } else if (hardCachedNodes) {\n    createdNodeIds = await restoreHardCachedNodes({\n      hardCachedNodes,\n    })\n  }\n\n  // save the node id's so we can touch them on the next build\n  // so that we don't have to refetch all nodes\n  await setPersistentCache({ key: CREATED_NODE_IDS, value: createdNodeIds })\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AAEA;;AAMA;;AAEA;AACA;AACA;AACA;AACA;AACO,MAAMA,sBAAsB,GAAG,OAAO;EAAEC;AAAF,CAAP,KAAyB;EAC7D,MAAM;IAAEC,aAAF;IAAiBC;EAAjB,IAA6BC,cAAA,CAAMC,QAAN,GAAiBC,SAApD;;EACA,MAAM;IAAEC;EAAF,IAAeJ,OAArB;EACA,MAAM;IACJK,GADI;IAEJC,MAAM,EAAE;MAAEC;IAAF;EAFJ,IAGFR,aAHJ;EAKA,MAAM;IAAES,eAAF;IAAmBC,QAAnB;IAA6BC;EAA7B,IAA0CZ,SAAhD;EAEA,MAAMa,QAAQ,GAAGF,QAAQ,CAACG,aAA1B;;EAEAX,cAAA,CAAMY,QAAN,CAAeC,MAAf,CAAsBC,mBAAtB,CAA0C;IACxCJ,QADwC;IAExCZ,aAFwC;IAGxCK;EAHwC,CAA1C;;EAMA,IAAIY,qBAAqB,GAAG,EAA5B,CAlB6D,CAoB7D;;EACA,KAAK,MAAMC,aAAX,IAA4BT,eAA5B,EAA6C;IAC3C,MAAMU,YAAY,GAAG,MAAM,IAAAC,yCAAA,EAAqB;MAC9CC,KAAK,EAAEb,OADuC;MAE9Cc,KAAK,EAAE,IAFuC;MAG9CC,iBAAiB,EAAEb,QAAQ,CAACc,UAHkB;MAI9CC,YAAY,EAAEf,QAAQ,CAACG,aAJuB;MAK9Ca,KAAK,EAAER,aALuC;MAM9CZ,GAN8C;MAO9CK,QAP8C;MAQ9CV;IAR8C,CAArB,CAA3B;IAWAgB,qBAAqB,GAAG,CAAC,GAAGA,qBAAJ,EAA2B,GAAGE,YAA9B,CAAxB;EACD;;EAEDjB,cAAA,CAAMY,QAAN,CAAeC,MAAf,CAAsBY,iBAAtB,CAAwC;IAAEf;EAAF,CAAxC;;EAEA,IAAIK,qBAAqB,IAAIA,qBAAqB,CAACW,MAAnD,EAA2D;IACzD,OAAO;MACLC,QAAQ,EAAE9B,SAAS,CAACW,QAAV,CAAmBoB,YADxB;MAELC,MAAM,EAAEhC,SAAS,CAACW,QAAV,CAAmBc,UAFtB;MAGLP;IAHK,CAAP;EAKD;;EAED,OAAO,KAAP;AACD,CA/CM;AAiDP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AACO,MAAMe,wBAAwB,GAAG,MAAM;EAC5C,MAAM;IAAEC;EAAF,IAAkB/B,cAAA,CAAMC,QAAN,GAAiB+B,YAAzC;;EACA,MAAMC,UAAU,GAAGC,MAAM,CAACC,MAAP,CAAcJ,WAAd,EAA2BK,MAA3B,CACjB,CAAC;IAAE3B;EAAF,CAAD,KAAkB,CAACA,QAAQ,CAAC4B,OADX,CAAnB;EAGA,OAAOJ,UAAP;AACD,CANM;;;AAQP,IAAIK,yBAAyB,GAAG,IAAhC;;AAEO,MAAMC,sBAAsB,GAAG,MAAM;EAC1C,IAAID,yBAAJ,EAA+B;IAC7B,OAAOA,yBAAP;EACD;;EAED,MAAM;IAAEE;EAAF,IAAcxC,cAAA,CAAMC,QAAN,GAAiB+B,YAArC;;EAEA,MAAMS,kBAAkB,GAAGX,wBAAwB,GAAGY,GAA3B,CACzBlB,KAAK,IAAIA,KAAK,CAAChB,QAAN,CAAeG,aADC,CAA3B;EAIA,MAAMgC,qBAAqB,GAAGF,kBAAkB,CAACG,MAAnB,CAC5B,CAACC,WAAD,EAAcC,QAAd,KAA2B;IAAA;;IACzB,MAAMC,IAAI,GAAGP,OAAO,CAACQ,GAAR,CAAYF,QAAZ,CAAb;;IAEA,2BAAIC,IAAI,CAACE,aAAT,gDAAI,oBAAoBvB,MAAxB,EAAgC;MAC9BmB,WAAW,GAAG,CACZ,GAAGA,WADS,EAEZ,GAAGE,IAAI,CAACE,aAAL,CAAmBP,GAAnB,CAAuB,CAAC;QAAEQ;MAAF,CAAD,KAAcA,IAArC,CAFS,CAAd;IAID;;IAED,OAAOL,WAAP;EACD,CAZ2B,EAa5B,EAb4B,CAA9B;EAgBA,MAAMM,YAAY,GAAG,CACnB,GAAG,IAAIC,GAAJ,CAAQ,CAAC,GAAGX,kBAAJ,EAAwB,GAAGE,qBAA3B,CAAR,CADgB,CAArB;EAIA,MAAMU,iBAAiB,GAAGF,YAAY,CAACT,GAAb,CAAiBI,QAAQ,IACjD,IAAAQ,sBAAA,EAAcR,QAAd,CADwB,CAA1B;EAIA,MAAMS,YAAY,GAAG,CAAC,GAAGJ,YAAJ,EAAkB,GAAGE,iBAArB,CAArB;;EAEA,IAAIE,YAAY,CAAC7B,MAAjB,EAAyB;IACvBY,yBAAyB,GAAGiB,YAA5B;EACD;;EAED,OAAOA,YAAP;AACD,CA1CM;AA4CP;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AACO,MAAMC,qBAAqB,GAAG,MAAMC,EAAN,IAAY;EAAA;;EAC/C,MAAM1B,WAAW,GAAGD,wBAAwB,EAA5C;EAEA,MAAM4B,SAAS,GAAG,0BAAAC,8BAAA,oGAAoBtD,MAApB,gFAA4BuD,kBAA5B,KAAkD,EAApE;EACA,MAAMC,cAAc,GAAG,IAAAC,cAAA,EAAM/B,WAAN,EAAmB2B,SAAnB,CAAvB;;EAEA,KAAK,MAAMK,OAAX,IAAsBF,cAAtB,EAAsC;IACpC,MAAMG,OAAO,CAACC,GAAR,CACJF,OAAO,CAACrB,GAAR,CAAY,MAAM7C,SAAN,IAAmB;MAC7B,KACE;MACCA,SAAS,CAACY,QAAV,CAAmByD,SAAnB,IACC;MACA,CAACC,qCAFH,IAGA;MACAtE,SAAS,CAACW,QAAV,CAAmBG,aAAnB,KAAsC,WANxC,EAOE;QACA;MACD;;MAED,MAAM8C,EAAE,CAAC;QAAE5D;MAAF,CAAD,CAAR;IACD,CAbD,CADI,CAAN;EAgBD;AACF,CAxBM;;;;AA0BA,MAAMuE,mCAAmC,GAAG,YAAY;EAC7D,MAAMC,iBAAiB,GAAG,EAA1B;EAEA,MAAMb,qBAAqB,CAAC,OAAO;IAAE3D;EAAF,CAAP,KAAyB;IACnD,MAAMyE,gBAAgB,GAAG,MAAM1E,sBAAsB,CAAC;MAAEC;IAAF,CAAD,CAArD;;IAEA,IAAIyE,gBAAJ,EAAsB;MACpBD,iBAAiB,CAACE,IAAlB,CAAuBD,gBAAvB;IACD;EACF,CAN0B,CAA3B;EAQA,OAAOD,iBAAP;AACD,CAZM;AAcP;AACA;AACA;AACA;AACA;AACA;;;;;AACO,MAAMG,sBAAsB,GAAG,YAAY;EAChD,MAAM;IAAEzE;EAAF,IAAc,IAAA0E,0BAAA,GAApB;EACA,MAAM;IAAEtE;EAAF,IAAeJ,OAArB,CAFgD,CAIhD;EACA;;EACA,MAAM2E,QAAQ,GAAGvE,QAAQ,CAACwE,aAAT,CAAuB,IAAAC,kCAAA,EAAkB,gBAAlB,CAAvB,CAAjB;EACAF,QAAQ,CAACG,KAAT;;EAEA7E,cAAA,CAAM8E,SAAN,CAAgB,MAAM;IACpBJ,QAAQ,CAACK,SAAT,CAAoB,GAAE/E,cAAA,CAAMC,QAAN,GAAiBY,MAAjB,CAAwBmE,WAAY,QAA1D;EACD,CAFD;;EAIA,IAAIC,cAAJ;EAEA,MAAMC,eAAe,GAAG,MAAM,IAAAC,yBAAA,GAA9B;;EAEA,IAAI,CAACD,eAAL,EAAsB;IACpB,MAAME,uBAAuB,GAAG,MAAMhB,mCAAmC,EAAzE;IAEA,MAAMiB,mBAAmB,GAAGlF,QAAQ,CAACwE,aAAT,CAC1B,IAAAC,kCAAA,EAAkB,gBAAlB,CAD0B,CAA5B;IAGAS,mBAAmB,CAACR,KAApB,GANoB,CAQpB;IACA;;IACAI,cAAc,GAAG,MAAM,IAAAK,mDAAA,EAAuC;MAC5DF,uBAD4D;MAE5DC;IAF4D,CAAvC,CAAvB;IAKA,MAAM,IAAAE,yBAAA,EAAmB;MAAExF;IAAF,CAAnB,CAAN;IAEAsF,mBAAmB,CAACG,GAApB;IACAd,QAAQ,CAACc,GAAT;EACD,CAnBD,MAmBO,IAAIN,eAAJ,EAAqB;IAC1BD,cAAc,GAAG,MAAM,IAAAQ,6BAAA,EAAuB;MAC5CP;IAD4C,CAAvB,CAAvB;EAGD,CAxC+C,CA0ChD;EACA;;;EACA,MAAM,IAAAQ,yBAAA,EAAmB;IAAEC,GAAG,EAAEC,2BAAP;IAAyBC,KAAK,EAAEZ;EAAhC,CAAnB,CAAN;AACD,CA7CM"}