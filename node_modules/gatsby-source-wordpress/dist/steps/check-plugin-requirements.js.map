{"version":3,"file":"check-plugin-requirements.js","names":["parseRange","range","set","versions","Range","isARange","length","minVersion","semver","version","maxVersion","message","areRemotePluginVersionsSatisfied","helpers","disableCompatibilityCheck","url","wpGraphQLEndpoint","wpgqlIsSatisfied","wpGatsbyIsSatisfied","data","fetchGraphql","query","variables","wpgqlVersion","supportedWpPluginVersions","WPGraphQL","wpgatsbyVersion","WPGatsby","panicOnError","throwGqlErrors","isFirstRequest","wpGatsbyCompatibility","satisfies","wpGQL","wpGatsby","e","includes","reporter","panic","formatLogMessage","genericDownloadMessage","shouldDisplayWPGraphQLReason","reason","shouldDisplayWPGatsbyReason","shouldDisplayAtleastOneReason","shouldDisplayBothReasons","reasons","hostname","protocol","parse","blankGetRequest","fetch","then","response","json","errors","firstError","debugMessage","catch","isWpGatsby","errorMap","from","to","prettyPermalinksAreEnabled","arePrettyPermalinksEnabled","log","warn","generalSettings","ensurePluginRequirementsAreMet","traceId","activity","activityTimer","start","gatsbyApi","pluginOptions","debug","remoteSchema","schemaWasChanged","store","getState","isFirstBuild","getPersistentCache","key","MD5_CACHE_KEY","end","Promise","all"],"sources":["../../src/steps/check-plugin-requirements.ts"],"sourcesContent":["import url from \"url\"\nimport Range from \"semver/classes/range\"\n\nimport type { NodePluginArgs } from \"gatsby\"\nimport fetch from \"node-fetch\"\n\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { getPersistentCache } from \"~/utils/cache\"\n\nimport store from \"~/store\"\nimport { MD5_CACHE_KEY } from \"~/constants\"\n\nimport {\n  supportedWpPluginVersions,\n  genericDownloadMessage,\n} from \"~/supported-remote-plugin-versions\"\n\nconst parseRange = (\n  range: string\n): {\n  message: string\n  minVersion: string\n  maxVersion: string\n  isARange: boolean\n} => {\n  const {\n    set: [versions],\n  } = new Range(range)\n\n  const isARange = versions.length >= 2\n  const minVersion = versions[0].semver.version\n  const maxVersion = versions[1]?.semver?.version\n\n  let message: string\n  if (isARange) {\n    message = `Install a version between ${minVersion} and ${maxVersion}.`\n  } else {\n    message = `Install version ${minVersion}.`\n  }\n\n  return {\n    message,\n    minVersion,\n    maxVersion,\n    isARange,\n  }\n}\n\nconst areRemotePluginVersionsSatisfied = async ({\n  helpers,\n  disableCompatibilityCheck,\n  url: wpGraphQLEndpoint,\n}: {\n  helpers: NodePluginArgs\n  url: string\n  disableCompatibilityCheck: boolean\n}): Promise<void> => {\n  if (disableCompatibilityCheck) {\n    return\n  }\n\n  let wpgqlIsSatisfied\n  let wpGatsbyIsSatisfied\n\n  try {\n    const { data } = await fetchGraphql({\n      query: /* GraphQL */ `\n        query WPGatsbyCompatibility(\n          $wpgqlVersion: String!\n          $wpgatsbyVersion: String!\n        ) {\n          wpGatsbyCompatibility(\n            wpGatsbyVersionRange: $wpgatsbyVersion\n            wpGQLVersionRange: $wpgqlVersion\n          ) {\n            satisfies {\n              wpGQL\n              wpGatsby\n            }\n          }\n        }\n      `,\n      variables: {\n        wpgqlVersion: supportedWpPluginVersions.WPGraphQL.version,\n        wpgatsbyVersion: supportedWpPluginVersions.WPGatsby.version,\n      },\n      panicOnError: false,\n      throwGqlErrors: true,\n      isFirstRequest: true,\n    })\n\n    wpgqlIsSatisfied = data.wpGatsbyCompatibility.satisfies.wpGQL\n    wpGatsbyIsSatisfied = data.wpGatsbyCompatibility.satisfies.wpGatsby\n  } catch (e) {\n    if (\n      e.message.includes(\n        `Cannot query field \"wpGatsbyCompatibility\" on type \"RootQuery\".`\n      )\n    ) {\n      helpers.reporter.panic(\n        formatLogMessage(\n          `Your version of WPGatsby is too old to determine if we're compatible.${genericDownloadMessage}`\n        )\n      )\n    } else {\n      helpers.reporter.panic(e.message)\n    }\n  }\n\n  const shouldDisplayWPGraphQLReason =\n    !wpgqlIsSatisfied && supportedWpPluginVersions.WPGraphQL.reason\n\n  const shouldDisplayWPGatsbyReason =\n    !wpGatsbyIsSatisfied && supportedWpPluginVersions.WPGatsby.reason\n\n  const shouldDisplayAtleastOneReason =\n    shouldDisplayWPGraphQLReason || shouldDisplayWPGatsbyReason\n\n  const shouldDisplayBothReasons =\n    shouldDisplayWPGraphQLReason && shouldDisplayWPGatsbyReason\n\n  // a message explaining why these are the minimum versions\n  const reasons = `${shouldDisplayAtleastOneReason ? `\\n\\nReasons:\\n\\n` : ``}${\n    shouldDisplayWPGraphQLReason\n      ? `- ${supportedWpPluginVersions.WPGraphQL.reason}`\n      : ``\n  }${shouldDisplayBothReasons ? `\\n\\n` : ``}${\n    shouldDisplayWPGatsbyReason\n      ? `- ${supportedWpPluginVersions.WPGatsby.reason}`\n      : ``\n  }`\n\n  let message = ``\n\n  if (!wpgqlIsSatisfied) {\n    const { minVersion, maxVersion } = parseRange(\n      supportedWpPluginVersions.WPGraphQL.version\n    )\n\n    message += `Your remote version of WPGraphQL is not within the accepted range\\n(${\n      supportedWpPluginVersions.WPGraphQL.version\n    }).\\n\\nThis is not a bug and it means one of two things:\\n you either need to upgrade WPGraphQL or gatsby-source-wordpress.\n\n1. If the version of WPGraphQL in your WordPress instance is higher than ${\n      maxVersion || minVersion\n    }\nit means you need to upgrade your version of gatsby-source-wordpress.\n\n2. If the version of WPGraphQL in your WordPress instance is lower than ${minVersion}\nit means you need to upgrade your version of WPGraphQL.\n\nYou can find a matching WPGraphQL version at https://github.com/wp-graphql/wp-graphql/releases`\n  }\n\n  if (!wpGatsbyIsSatisfied && !wpgqlIsSatisfied) {\n    message += `\\n\\n---------------\\n\\n`\n  }\n\n  if (!wpGatsbyIsSatisfied) {\n    const { minVersion, maxVersion } = parseRange(\n      supportedWpPluginVersions.WPGatsby.version\n    )\n\n    const { hostname, protocol } = url.parse(wpGraphQLEndpoint)\n\n    message += `Your remote version of WPGatsby is not within the accepted range\\n(${\n      supportedWpPluginVersions.WPGatsby.version\n    })\\n\\nThis is not a bug and it means one of two things:\\n you either need to upgrade WPGatsby or gatsby-source-wordpress.\n\n1. If the version of WPGatsby in your WordPress instance is higher than ${\n      maxVersion || minVersion\n    }\nit means you need to upgrade your version of gatsby-source-wordpress.\n\n2. If the version of WPGatsby in your WordPress instance is lower than ${minVersion}\nit means you need to upgrade your version of WPGatsby.\n\nDownload a matching version at https://github.com/gatsbyjs/wp-gatsby/releases\nor update via ${protocol}//${hostname}/wp-admin/plugins.php`\n  }\n\n  if (!wpGatsbyIsSatisfied || !wpgqlIsSatisfied) {\n    message += `\n${reasons}`\n  }\n\n  if (message) {\n    helpers.reporter.panic(formatLogMessage(message))\n  }\n}\n\n// This blank request is used to find debug messages\n// when a graphql request is made with no query\n// for example if 2 root fields are registered with the fieldname \"products\"\n// this will throw a helpful error message explaining that one should be removed\nconst blankGetRequest = async ({\n  url,\n  helpers,\n}: {\n  url: string\n  helpers: NodePluginArgs\n}): Promise<void> =>\n  fetch(url)\n    .then(response => response.json())\n    .then(json => {\n      if (json?.errors?.length) {\n        const firstError = json.errors[0]\n\n        if (\n          firstError.debugMessage ||\n          (firstError.message &&\n            !firstError.message?.includes(\n              `GraphQL Request must include at least one of those two parameters: \"query\" or \"queryId\"`\n            ))\n        ) {\n          helpers.reporter.panic(\n            formatLogMessage(`WPGraphQL returned a debug message on startup:\n\n${firstError.debugMessage || firstError.message}\n          `)\n          )\n        }\n      }\n    })\n    .catch(() => {\n      // this is ignored because a /graphql request will always return a 200 at this point\n      // we've already checked prior to this point that /graphql is up and returns a response.\n    })\n\nconst isWpGatsby = async (): Promise<void> => {\n  fetchGraphql({\n    query: /* GraphQL */ `\n      {\n        isWpGatsby\n      }\n    `,\n    errorMap: {\n      from: `Cannot query field \"isWpGatsby\" on type \"RootQuery\".`,\n      // @todo replace this link with another once we're out of alpha\n      to: `WPGatsby is not active in your WordPress installation.\\nTo download the latest version of WPGatsby visit https://wordpress.org/plugins/wp-gatsby/`,\n    },\n    panicOnError: true,\n    isFirstRequest: true,\n  })\n}\n\nconst prettyPermalinksAreEnabled = async ({\n  helpers,\n}: {\n  helpers: NodePluginArgs\n}): Promise<void> => {\n  try {\n    const { data } = await fetchGraphql({\n      query: /* GraphQL */ `\n        {\n          generalSettings {\n            url\n          }\n          wpGatsby {\n            arePrettyPermalinksEnabled\n          }\n        }\n      `,\n      throwGqlErrors: true,\n      isFirstRequest: true,\n    })\n\n    if (!data.wpGatsby.arePrettyPermalinksEnabled) {\n      helpers.reporter.log(``)\n      helpers.reporter.warn(\n        formatLogMessage(`\nPretty permalinks are not enabled in your WordPress instance.\nGatsby routing requires this setting to function properly.\nPlease enable pretty permalinks by changing your settings at\n${data.generalSettings.url}/wp-admin/options-permalink.php.\n`)\n      )\n    }\n  } catch (e) {\n    // the WPGatsby version is too old to query for wpGatsby.arePrettyPermalinksEnabled\n  }\n}\n\nconst ensurePluginRequirementsAreMet = async (\n  helpers: NodePluginArgs\n): Promise<void> => {\n  if (\n    helpers.traceId === `refresh-createSchemaCustomization` ||\n    // PQR doesn't have a trace id.\n    // By the time this runs in PQR we don't need it to run again.\n    !helpers.traceId\n  ) {\n    return\n  }\n\n  const activity = helpers.reporter.activityTimer(\n    formatLogMessage(`ensuring plugin requirements are met`)\n  )\n\n  activity.start()\n\n  const {\n    gatsbyApi: {\n      pluginOptions: {\n        url,\n        debug: { disableCompatibilityCheck },\n      },\n    },\n    remoteSchema: { schemaWasChanged },\n  } = store.getState()\n\n  // if we don't have a cached remote schema MD5, this is a cold build\n  const isFirstBuild = !(await getPersistentCache({ key: MD5_CACHE_KEY }))\n\n  if (\n    !schemaWasChanged &&\n    !isFirstBuild &&\n    helpers.traceId !== `schemaWasChanged`\n  ) {\n    activity.end()\n    return\n  }\n\n  await blankGetRequest({ url, helpers })\n  await isWpGatsby()\n\n  await Promise.all([\n    prettyPermalinksAreEnabled({ helpers }),\n    areRemotePluginVersionsSatisfied({\n      helpers,\n      url,\n      disableCompatibilityCheck,\n    }),\n  ])\n\n  activity.end()\n}\n\nexport { ensurePluginRequirementsAreMet }\n"],"mappings":"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"}