{"version":3,"file":"diff-schemas.js","names":["checkIfSchemaHasChanged","traceId","state","store","getState","helpers","pluginOptions","gatsbyApi","lastCompletedSourceTime","cache","get","LAST_COMPLETED_SOURCE_TIME","activity","reporter","activityTimer","formatLogMessage","verbose","start","data","fetchGraphql","query","schemaMd5","generalSettings","url","wpUrl","parse","protocol","log","warn","cachedSchemaMd5","MD5_CACHE_KEY","foundUsableHardCachedData","getHardCachedData","key","getHardCachedNodes","setPersistentCache","value","schemaWasChanged","ensurePluginRequirementsAreMet","pluginOptionsMD5Key","lastPluginOptionsMD5","getPersistentCache","pluginOptionsMD5","createContentDigest","type","shouldClearHardCache","clearHardCache","process","env","NODE_ENV","info","dispatch","remoteSchema","setState","end"],"sources":["../../../src/steps/ingest-remote-schema/diff-schemas.js"],"sourcesContent":["import url from \"url\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport store from \"~/store\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { LAST_COMPLETED_SOURCE_TIME, MD5_CACHE_KEY } from \"~/constants\"\n\nimport { ensurePluginRequirementsAreMet } from \"../check-plugin-requirements\"\n\nimport { createContentDigest } from \"gatsby-core-utils\"\n\nimport {\n  clearHardCache,\n  getHardCachedData,\n  getHardCachedNodes,\n  setPersistentCache,\n  getPersistentCache,\n} from \"~/utils/cache\"\n\nconst checkIfSchemaHasChanged = async ({ traceId }) => {\n  const state = store.getState()\n\n  const { helpers, pluginOptions } = state.gatsbyApi\n\n  const lastCompletedSourceTime = await helpers.cache.get(\n    LAST_COMPLETED_SOURCE_TIME\n  )\n\n  const activity = helpers.reporter.activityTimer(\n    formatLogMessage(`diff schemas`)\n  )\n\n  if (pluginOptions.verbose && lastCompletedSourceTime) {\n    activity.start()\n  }\n\n  const { data } = await fetchGraphql({\n    query: /* GraphQL */ `\n      {\n        schemaMd5\n        # also get the wpUrl to save on # of requests\n        # @todo maybe there's a better place for this\n        generalSettings {\n          url\n        }\n      }\n    `,\n  })\n\n  const {\n    schemaMd5,\n    generalSettings: { url: wpUrl },\n  } = data\n\n  if (url.parse(wpUrl).protocol !== url.parse(pluginOptions.url).protocol) {\n    helpers.reporter.log(``)\n    helpers.reporter.warn(\n      formatLogMessage(`\n\nThe Url set in plugin options has a different protocol than the Url saved in WordPress general settings.\n\noptions.url: ${pluginOptions.url}\nWordPress settings: ${wpUrl}\n\nThis may cause subtle bugs, or it may be fine.\nPlease consider addressing this issue by changing your WordPress settings or plugin options accordingly.\n\n`)\n    )\n  }\n\n  let cachedSchemaMd5 = await helpers.cache.get(MD5_CACHE_KEY)\n\n  let foundUsableHardCachedData\n\n  if (!cachedSchemaMd5) {\n    cachedSchemaMd5 = await getHardCachedData({\n      key: MD5_CACHE_KEY,\n    })\n\n    foundUsableHardCachedData =\n      cachedSchemaMd5 && !!(await getHardCachedNodes())\n  }\n\n  await setPersistentCache({ key: MD5_CACHE_KEY, value: schemaMd5 })\n\n  const schemaWasChanged = schemaMd5 !== cachedSchemaMd5\n\n  // if the schema was changed and we had a cached schema\n  // we need to re-check to see if all plugin requirements are met\n  // this is also run as a step in gatsby-node.js but is skipped\n  // during refreshes. If the schema changes and this is a refresh\n  // we do want to re-check to make sure everything's good.\n  if (\n    schemaWasChanged &&\n    cachedSchemaMd5 &&\n    traceId !== `initial-createSchemaCustomization`\n  ) {\n    await ensurePluginRequirementsAreMet({\n      ...helpers,\n      traceId: `schemaWasChanged`,\n    })\n  }\n\n  const pluginOptionsMD5Key = `plugin-options-md5`\n  const lastPluginOptionsMD5 = await getPersistentCache({\n    key: pluginOptionsMD5Key,\n  })\n\n  const pluginOptionsMD5 = createContentDigest({\n    url: pluginOptions.url,\n    type: pluginOptions.type,\n  })\n\n  const shouldClearHardCache =\n    schemaWasChanged || lastPluginOptionsMD5 !== pluginOptionsMD5\n\n  if (shouldClearHardCache && foundUsableHardCachedData) {\n    await clearHardCache()\n\n    foundUsableHardCachedData = false\n  }\n\n  await setPersistentCache({\n    key: pluginOptionsMD5Key,\n    value: pluginOptionsMD5,\n  })\n\n  if (\n    lastCompletedSourceTime &&\n    schemaWasChanged &&\n    pluginOptions &&\n    pluginOptions.verbose\n  ) {\n    helpers.reporter.log(``)\n    helpers.reporter.warn(\n      formatLogMessage(`The remote schema has changed, updating local schema.`)\n    )\n    if (process.env.NODE_ENV === `development`) {\n      helpers.reporter.warn(\n        formatLogMessage(\n          `If the schema change includes a data change\\nyou'll need to run \\`gatsby clean && gatsby develop\\` to see the data update.`\n        )\n      )\n    }\n    helpers.reporter.info(\n      formatLogMessage(`Cached schema md5: ${cachedSchemaMd5}`)\n    )\n    helpers.reporter.info(formatLogMessage(`Remote schema md5: ${schemaMd5}`))\n    helpers.reporter.log(``)\n  } else if (!lastCompletedSourceTime && pluginOptions.verbose) {\n    helpers.reporter.log(``)\n    helpers.reporter.info(\n      formatLogMessage(\n        `\\n\\n\\tThis is either your first build or the cache was cleared.\\n\\tPlease wait while your WordPress data is synced to your Gatsby cache.\\n\\n\\tMaybe now's a good time to get up and stretch? :D\\n`\n      )\n    )\n  }\n\n  // record wether the schema changed so other logic can beware\n  // as well as the wpUrl because we need this sometimes :p\n  store.dispatch.remoteSchema.setState({\n    schemaWasChanged,\n    wpUrl,\n    foundUsableHardCachedData,\n  })\n\n  if (pluginOptions.verbose && lastCompletedSourceTime) {\n    activity.end()\n  }\n\n  return schemaWasChanged\n}\n\nexport { checkIfSchemaHasChanged }\n"],"mappings":"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"}