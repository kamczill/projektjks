{"version":3,"file":"cleanup.js","names":["invokeLeftoverPreviewCallback","getNode","status","context","error","nodeId","callback","passedNode","pageNode","path","invokeAndCleanupLeftoverPreviewCallbacks","state","store","getState","gatsbyApi","helpers","leftoverCallbacks","previewStore","nodePageCreatedCallbacks","leftoverCallbacksExist","Object","keys","length","Promise","all","entries","map","dispatch","clearPreviewCallbacks","onPreExtractQueriesInvokeLeftoverPreviewCallbacks","inPreviewMode"],"sources":["../../../src/steps/preview/cleanup.ts"],"sourcesContent":["import { inPreviewMode, PreviewStatusUnion } from \".\"\nimport { OnPageCreatedCallback } from \"~/models/preview\"\nimport store from \"~/store\"\nimport { NodePluginArgs } from \"gatsby\"\n\n/**\n * This callback is invoked to send WP the preview status. In this case the status\n * is that we couldn't find a page for the node being previewed\n */\nconst invokeLeftoverPreviewCallback =\n  ({\n    getNode,\n    status,\n    context,\n    error,\n  }: {\n    status: PreviewStatusUnion\n    context?: string\n    error?: Error\n    getNode: NodePluginArgs[\"getNode\"]\n  }) =>\n  async ([nodeId, callback]: [\n    string,\n    OnPageCreatedCallback\n  ]): Promise<void> => {\n    const passedNode = getNode(nodeId)\n\n    await callback({\n      passedNode,\n      nodeId,\n      // we pass null as the path because no page was created for this node.\n      // if it had been, this callback would've been removed earlier in the process\n      pageNode: { path: null },\n      status,\n      context,\n      error,\n    })\n  }\n\nexport const invokeAndCleanupLeftoverPreviewCallbacks = async ({\n  status,\n  context,\n  error,\n}: {\n  status: PreviewStatusUnion\n  context?: string\n  error?: Error\n}): Promise<void> => {\n  const state = store.getState()\n\n  const { getNode } = state.gatsbyApi.helpers\n\n  const leftoverCallbacks = state.previewStore.nodePageCreatedCallbacks\n\n  const leftoverCallbacksExist = Object.keys(leftoverCallbacks).length\n\n  if (leftoverCallbacksExist) {\n    await Promise.all(\n      Object.entries(leftoverCallbacks).map(\n        invokeLeftoverPreviewCallback({ getNode, status, context, error })\n      )\n    )\n\n    // after processing our callbacks, we need to remove them all so they don't get called again in the future\n    store.dispatch.previewStore.clearPreviewCallbacks()\n  }\n}\n\n/**\n * Preview callbacks are usually invoked during onCreatePage in Gatsby Preview\n * so that we can send back the preview status of a created page to WP\n * In the case that no page is created for the node we're previewing, we'll\n * have callbacks hanging around and WP will not know the status of the preview\n * So in onPreExtractQueries (which runs after pages are created), we check which\n * preview callbacks haven't been invoked, and invoke them with a \"NO_PAGE_CREATED_FOR_PREVIEWED_NODE\" status, which sends that status to WP\n * After invoking all these leftovers, we clear them out from the store so they aren't called again later.\n */\nexport const onPreExtractQueriesInvokeLeftoverPreviewCallbacks =\n  async (): Promise<void> => {\n    if (!inPreviewMode()) {\n      return invokeAndCleanupLeftoverPreviewCallbacks({\n        status: `GATSBY_PREVIEW_PROCESS_ERROR`,\n        context: `Gatsby is not in Preview mode.`,\n      })\n    }\n\n    // check for any onCreatePageCallbacks that weren't called during createPages\n    // we need to tell WP that a page wasn't created for the preview\n    return invokeAndCleanupLeftoverPreviewCallbacks({\n      status: `NO_PAGE_CREATED_FOR_PREVIEWED_NODE`,\n      context: `invokeAndCleanupLeftoverPreviewCallbacks`,\n    })\n  }\n"],"mappings":";;;;;;;AAAA;;AAEA;;AAGA;AACA;AACA;AACA;AACA,MAAMA,6BAA6B,GACjC,CAAC;EACCC,OADD;EAECC,MAFD;EAGCC,OAHD;EAICC;AAJD,CAAD,KAWA,OAAO,CAACC,MAAD,EAASC,QAAT,CAAP,KAGqB;EACnB,MAAMC,UAAU,GAAGN,OAAO,CAACI,MAAD,CAA1B;EAEA,MAAMC,QAAQ,CAAC;IACbC,UADa;IAEbF,MAFa;IAGb;IACA;IACAG,QAAQ,EAAE;MAAEC,IAAI,EAAE;IAAR,CALG;IAMbP,MANa;IAObC,OAPa;IAQbC;EARa,CAAD,CAAd;AAUD,CA5BH;;AA8BO,MAAMM,wCAAwC,GAAG,OAAO;EAC7DR,MAD6D;EAE7DC,OAF6D;EAG7DC;AAH6D,CAAP,KAQnC;EACnB,MAAMO,KAAK,GAAGC,cAAA,CAAMC,QAAN,EAAd;;EAEA,MAAM;IAAEZ;EAAF,IAAcU,KAAK,CAACG,SAAN,CAAgBC,OAApC;EAEA,MAAMC,iBAAiB,GAAGL,KAAK,CAACM,YAAN,CAAmBC,wBAA7C;EAEA,MAAMC,sBAAsB,GAAGC,MAAM,CAACC,IAAP,CAAYL,iBAAZ,EAA+BM,MAA9D;;EAEA,IAAIH,sBAAJ,EAA4B;IAC1B,MAAMI,OAAO,CAACC,GAAR,CACJJ,MAAM,CAACK,OAAP,CAAeT,iBAAf,EAAkCU,GAAlC,CACE1B,6BAA6B,CAAC;MAAEC,OAAF;MAAWC,MAAX;MAAmBC,OAAnB;MAA4BC;IAA5B,CAAD,CAD/B,CADI,CAAN,CAD0B,CAO1B;;IACAQ,cAAA,CAAMe,QAAN,CAAeV,YAAf,CAA4BW,qBAA5B;EACD;AACF,CA3BM;AA6BP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AACO,MAAMC,iDAAiD,GAC5D,YAA2B;EACzB,IAAI,CAAC,IAAAC,eAAA,GAAL,EAAsB;IACpB,OAAOpB,wCAAwC,CAAC;MAC9CR,MAAM,EAAG,8BADqC;MAE9CC,OAAO,EAAG;IAFoC,CAAD,CAA/C;EAID,CANwB,CAQzB;EACA;;;EACA,OAAOO,wCAAwC,CAAC;IAC9CR,MAAM,EAAG,oCADqC;IAE9CC,OAAO,EAAG;EAFoC,CAAD,CAA/C;AAID,CAfI"}