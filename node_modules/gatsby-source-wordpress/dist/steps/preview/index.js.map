{"version":3,"file":"index.js","names":["inDevelopPreview","process","env","NODE_ENV","ENABLE_GATSBY_REFRESH_ENDPOINT","inPreviewRunner","RUNNER_TYPE","IS_GATSBY_PREVIEW","inPreviewMode","previewQueue","getPreviewQueue","previewRequestConcurrency","store","getState","gatsbyApi","pluginOptions","schema","PQueue","concurrency","carryoverConcurrencyCount","previewForIdIsAlreadyBeingProcessed","id","existingCallbacks","previewStore","nodePageCreatedCallbacks","alreadyProcessingThisPreview","writeDummyPageDataJsonIfNeeded","previewData","pageNode","isDraft","pageDataDirectory","path","join","cwd","fs","ensureDir","pageDataPath","pageDataExists","pathExists","writeJSON","createPreviewStatusCallback","reporter","passedNode","context","status","graphqlEndpoint","error","statusContext","message","data","fetchGraphql","url","query","variables","input","clientMutationId","modified","pagePath","parentDatabaseId","previewDatabaseId","errorContext","forceReportCriticalErrors","headers","WPGatsbyPreview","token","WPGatsbyPreviewUser","userDatabaseId","wpGatsbyRemotePreviewStatus","success","log","formatLogMessage","sourcePreview","actions","requiredProperties","missingProperties","filter","property","length","warn","info","JSON","stringify","touchValidNodes","sendPreviewStatus","dispatch","subscribeToPagesCreatedFromNodeById","nodeId","node","fetchAndCreateSingleNode","actionType","previewParentId","isPreview","manifestIds","forEach","manifestId","unstable_createNodeManifest","sourcePreviews","helpers","webhookBody","debug","preview","inPreviewDebugModeOption","getPluginOptions","remoteUrl","hostname","settingsHostname","urlUtil","parse","remoteHostname","databaseId","chalk","bold","inPreviewDebugMode","WP_GATSBY_PREVIEW_DEBUG","dump","wpGatsbyPreviewNodeManifestsAreSupported","remoteSchemaSupportsFieldNameOnTypeName","typeName","fieldName","previewActions","paginatedWpNodeFetch","contentTypePlural","nodeTypeName","Date","now","queue","add","Promise","all","onEmpty","onIdle","invokeAndCleanupLeftoverPreviewCallbacks"],"sources":["../../../src/steps/preview/index.ts"],"sourcesContent":["import { getPluginOptions } from \"./../../utils/get-gatsby-api\"\nimport { GatsbyHelpers } from \"~/utils/gatsby-types\"\nimport path from \"path\"\nimport fs from \"fs-extra\"\nimport chalk from \"chalk\"\nimport urlUtil from \"url\"\nimport PQueue from \"p-queue\"\nimport { dump } from \"dumper.js\"\nimport { actions as gatsbyActions } from \"gatsby/dist/redux/actions/public\"\n\nimport { remoteSchemaSupportsFieldNameOnTypeName } from \"~/steps/ingest-remote-schema/introspect-remote-schema\"\nimport { paginatedWpNodeFetch } from \"~/steps/source-nodes/fetch-nodes/fetch-nodes-paginated\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\n\nimport store from \"~/store\"\n\nimport { fetchAndCreateSingleNode } from \"~/steps/source-nodes/update-nodes/wp-actions/update\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { touchValidNodes } from \"../source-nodes/update-nodes/fetch-node-updates\"\n\nimport { Reporter } from \"gatsby/reporter\"\nimport { invokeAndCleanupLeftoverPreviewCallbacks } from \"./cleanup\"\n\nconst inDevelopPreview =\n  process.env.NODE_ENV === `development` &&\n  !!process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n\nconst inPreviewRunner =\n  process.env.RUNNER_TYPE === `PREVIEW` ||\n  process.env.RUNNER_TYPE === `INCREMENTAL_PREVIEWS` ||\n  !!process.env.IS_GATSBY_PREVIEW\n\n// this is a function simply because many places in the code expect it to be.\n// it used to call store.getState() and check for some state to determine preview mode\nexport const inPreviewMode = (): boolean => inDevelopPreview || inPreviewRunner\n\nexport type PreviewStatusUnion =\n  | `PREVIEW_SUCCESS`\n  | `NO_PAGE_CREATED_FOR_PREVIEWED_NODE`\n  | `GATSBY_PREVIEW_PROCESS_ERROR`\n  | `RECEIVED_PREVIEW_DATA_FROM_WRONG_URL`\n\nexport interface IPreviewData {\n  previewDatabaseId: number\n  userDatabaseId: number\n  token: string\n  remoteUrl: string\n  modified: string\n  parentDatabaseId: number\n  id: string\n  isDraft: boolean\n  singleName: string\n  since?: number\n  refreshing?: boolean\n  preview?: boolean\n  manifestIds?: Array<string>\n}\n\ninterface IPageNode {\n  path: string\n}\n\nlet previewQueue: PQueue\n\nconst getPreviewQueue = (): PQueue => {\n  if (!previewQueue) {\n    const { previewRequestConcurrency } =\n      store.getState().gatsbyApi.pluginOptions.schema\n\n    previewQueue = new PQueue({\n      concurrency: previewRequestConcurrency,\n      carryoverConcurrencyCount: true,\n    })\n  }\n\n  return previewQueue\n}\n\n// This checks wether or not we're already currently processing a preview\n// for the passed preview id.\nconst previewForIdIsAlreadyBeingProcessed = (id: string): boolean => {\n  if (!id) {\n    return false\n  }\n\n  const existingCallbacks =\n    store.getState().previewStore.nodePageCreatedCallbacks\n\n  const alreadyProcessingThisPreview = !!existingCallbacks?.[id]\n\n  return alreadyProcessingThisPreview\n}\n\n/**\n * For previews of draft posts, gatsby develop will throw a bunch of 404 errors\n * while WPGatsby is trying to read page-data.json\n * So we can write a dummy page-data.json if one doesn't exist.\n * that way there will be no 404's and Gatsby will overwrite our dummy file when it\n * needs to.\n */\nconst writeDummyPageDataJsonIfNeeded = async ({\n  previewData,\n  pageNode,\n}: {\n  previewData: IPreviewData\n  pageNode: IPageNode\n}): Promise<void> => {\n  if (!previewData.isDraft) {\n    return\n  }\n\n  const pageDataDirectory = path.join(\n    process.cwd(),\n    `public/page-data`,\n    pageNode.path\n  )\n\n  await fs.ensureDir(pageDataDirectory)\n\n  const pageDataPath = path.join(pageDataDirectory, `page-data.json`)\n\n  const pageDataExists = await fs.pathExists(pageDataPath)\n\n  if (!pageDataExists) {\n    await fs.writeJSON(pageDataPath, {\n      isDraft: previewData.isDraft,\n    })\n  }\n}\n\ninterface IOnPreviewStatusInput {\n  status: PreviewStatusUnion\n  context?: string\n  nodeId?: string\n  passedNode?: {\n    modified?: string\n    databaseId: number\n  }\n  pageNode?: IPageNode\n  graphqlEndpoint?: string\n  error?: Error\n}\n\nconst createPreviewStatusCallback =\n  ({\n    previewData,\n    reporter,\n  }: {\n    previewData: IPreviewData\n    reporter: Reporter\n  }) =>\n  async ({\n    passedNode,\n    pageNode,\n    context,\n    status,\n    graphqlEndpoint,\n    error,\n  }: IOnPreviewStatusInput): Promise<void> => {\n    if (status === `PREVIEW_SUCCESS`) {\n      // we might need to write a dummy page-data.json so that\n      // Gatsby doesn't throw 404 errors when WPGatsby tries to read this file\n      // that maybe doesn't exist yet\n      await writeDummyPageDataJsonIfNeeded({ previewData, pageNode })\n    }\n\n    const statusContext = error?.message\n      ? `${context}\\n\\n${error.message}`\n      : context\n\n    const { data } = await fetchGraphql({\n      url: graphqlEndpoint,\n      query: /* GraphQL */ `\n        mutation MUTATE_PREVIEW_NODE(\n          $input: WpGatsbyRemotePreviewStatusInput!\n        ) {\n          wpGatsbyRemotePreviewStatus(input: $input) {\n            success\n          }\n        }\n      `,\n      variables: {\n        input: {\n          clientMutationId: `sendPreviewStatus`,\n          modified: passedNode?.modified,\n          pagePath: pageNode?.path,\n          parentDatabaseId:\n            previewData.parentDatabaseId || previewData.previewDatabaseId, // if the parentDatabaseId is 0 we want to use the previewDatabaseId\n          status,\n          statusContext,\n        },\n      },\n      errorContext: `Error occurred while mutating WordPress Preview node meta.`,\n      forceReportCriticalErrors: true,\n      headers: {\n        WPGatsbyPreview: previewData.token,\n        WPGatsbyPreviewUser: previewData.userDatabaseId,\n      },\n    })\n\n    if (data?.wpGatsbyRemotePreviewStatus?.success) {\n      reporter.log(\n        formatLogMessage(\n          `Successfully sent Preview status back to WordPress post ${previewData.id} during ${context}`\n        )\n      )\n    } else {\n      reporter.log(\n        formatLogMessage(\n          `failed to mutate WordPress post ${previewData.id} during Preview ${context}.\\nCheck your WP server logs for more information.`\n        )\n      )\n    }\n  }\n\n/**\n * This is called and passed the result from the ActionMonitor.previewData object along with a JWT token\n * It sources a single preview and creates the callback that's invoked to send preview status back to WPGatsby.\n * When the preview status is sent back to Gatsby, the preview action that this\n * logic is processing is deleted in the WP instance. That's why we call\n * previewForIdIsAlreadyBeingProcessed to see if another preview webhook\n * already started processing for this action\n */\nexport const sourcePreview = async ({\n  previewData,\n  reporter,\n  actions,\n}: {\n  previewData: IPreviewData\n  reporter: Reporter\n  actions: typeof gatsbyActions\n}): Promise<void> => {\n  if (previewForIdIsAlreadyBeingProcessed(previewData?.id)) {\n    return\n  }\n\n  const requiredProperties = [\n    `previewDatabaseId`,\n    `id`,\n    `token`,\n    `remoteUrl`,\n    `parentDatabaseId`,\n    `modified`,\n    `userDatabaseId`,\n  ]\n\n  const missingProperties = requiredProperties.filter(\n    property => !(property in previewData)\n  )\n\n  if (!previewData || missingProperties.length) {\n    reporter.warn(\n      formatLogMessage(\n        `sourcePreview was called but the required previewData properties weren't provided.`\n      )\n    )\n    reporter.info(\n      formatLogMessage(\n        `Missing properties: \\n${JSON.stringify(missingProperties, null, 2)}`\n      )\n    )\n    reporter.log(\n      formatLogMessage(`previewData: \\n${JSON.stringify(previewData, null, 2)}`)\n    )\n    return\n  }\n\n  await touchValidNodes()\n\n  const sendPreviewStatus = createPreviewStatusCallback({\n    previewData,\n    reporter,\n  })\n\n  // this callback will be invoked when the page is created/updated for this node\n  // then it'll send a mutation to WPGraphQL so that WP knows the preview is ready\n  store.dispatch.previewStore.subscribeToPagesCreatedFromNodeById({\n    nodeId: previewData.id,\n    modified: previewData.modified,\n    sendPreviewStatus,\n  })\n\n  const { node } = await fetchAndCreateSingleNode({\n    actionType: `PREVIEW`,\n    ...previewData,\n    previewParentId: previewData.parentDatabaseId,\n    isPreview: true,\n  })\n\n  if (\n    previewData?.manifestIds?.length &&\n    `unstable_createNodeManifest` in actions &&\n    node\n  ) {\n    previewData.manifestIds.forEach(manifestId => {\n      actions.unstable_createNodeManifest({\n        manifestId,\n        node,\n      })\n    })\n  }\n}\n\n/**\n * This is called when the /__refresh endpoint is posted to from WP previews.\n * It should only ever run in Preview mode, which is process.env.ENABLE_GATSBY_REFRESH_ENDPOINT = true\n * It first sources all pending preview actions, then calls sourcePreview() for each of them.\n */\nexport const sourcePreviews = async (helpers: GatsbyHelpers): Promise<void> => {\n  const { webhookBody, reporter, actions } = helpers\n  const {\n    debug: { preview: inPreviewDebugModeOption },\n    url,\n  } = getPluginOptions()\n\n  // some versions of WPGatsby don't send a remoteUrl on every webhook.\n  // if we check this for every webhookBody errors will occur!\n  if (webhookBody.remoteUrl) {\n    // check if we're receiving preview data fromt the right WP backend\n    const { hostname: settingsHostname } = urlUtil.parse(url)\n    const { hostname: remoteHostname } = urlUtil.parse(webhookBody.remoteUrl)\n\n    if (settingsHostname !== remoteHostname) {\n      const sendPreviewStatus = createPreviewStatusCallback({\n        previewData: webhookBody,\n        reporter,\n      })\n\n      await sendPreviewStatus({\n        status: `RECEIVED_PREVIEW_DATA_FROM_WRONG_URL`,\n        context: `check that the preview data came from the right URL.`,\n        passedNode: {\n          modified: webhookBody.modified,\n          databaseId: webhookBody.parentDatabaseId,\n        },\n        graphqlEndpoint: webhookBody.remoteUrl,\n      })\n\n      reporter.warn(\n        formatLogMessage(\n          `Received preview data from a different remote URL than the one specified in plugin options. Preview will not work. Please send preview requests from the WP instance configured in gatsby-config.js.\\n\\n ${chalk.bold(\n            `Remote URL:`\n          )} ${webhookBody.remoteUrl}\\n ${chalk.bold(\n            `Plugin options URL:`\n          )} ${url}\\n\\n`\n        )\n      )\n\n      return\n    }\n  }\n\n  const inPreviewDebugMode =\n    inPreviewDebugModeOption || process.env.WP_GATSBY_PREVIEW_DEBUG\n\n  if (inPreviewDebugMode) {\n    reporter.info(`Sourcing previews for the following webhook:`)\n    dump(webhookBody)\n  }\n\n  const wpGatsbyPreviewNodeManifestsAreSupported =\n    await remoteSchemaSupportsFieldNameOnTypeName({\n      typeName: `GatsbyPreviewData`,\n      fieldName: `manifestIds`,\n    })\n\n  const previewActions = await paginatedWpNodeFetch({\n    contentTypePlural: `actionMonitorActions`,\n    nodeTypeName: `ActionMonitor`,\n    headers: {\n      WPGatsbyPreview: webhookBody.token,\n      WPGatsbyPreviewUser: webhookBody.userDatabaseId,\n    },\n    helpers,\n    query: /* GraphQL */ `\n      query PREVIEW_ACTIONS($after: String) {\n        actionMonitorActions(\n          where: {\n            previewStream: true\n            status: PRIVATE\n            orderby: { field: MODIFIED, order: DESC }\n            sinceTimestamp: ${\n              // only source previews made in the last 60 minutes\n              // We delete every preview action we process so this accounts for very long cold builds between previews.\n              Date.now() - 1000 * 60 * 60\n            }\n          }\n          first: 100\n          after: $after\n        ) {\n          nodes {\n            previewData {\n              id\n              isDraft\n              modified\n              parentDatabaseId\n              previewDatabaseId\n              remoteUrl\n              singleName\n              userDatabaseId\n              ${wpGatsbyPreviewNodeManifestsAreSupported ? `manifestIds` : ``}\n            }\n          }\n          pageInfo {\n            hasNextPage\n            endCursor\n          }\n        }\n      }\n    `,\n  })\n\n  if (!previewActions?.length) {\n    if (inPreviewDebugMode) {\n      reporter.info(\n        `Preview for id ${webhookBody?.id} returned no action monitor actions.`\n      )\n    }\n    return\n  }\n\n  if (inPreviewDebugMode) {\n    reporter.info(\n      `Preview for id ${webhookBody?.id} returned the following actions:`\n    )\n    dump(previewActions)\n  }\n\n  const queue = getPreviewQueue()\n\n  for (const { previewData } of previewActions) {\n    queue.add(() =>\n      sourcePreview({\n        previewData: { ...previewData, token: webhookBody.token },\n        reporter,\n        actions,\n      })\n    )\n  }\n\n  await Promise.all([queue.onEmpty(), queue.onIdle()])\n\n  // clean up leftover callbacks at the end to clean up anything we didn't catch elsewhere\n  await invokeAndCleanupLeftoverPreviewCallbacks({\n    status: `GATSBY_PREVIEW_PROCESS_ERROR`,\n    context: `Starting sourcePreviews`,\n  })\n}\n"],"mappings":";;;;;;;AAAA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAGA;;AACA;;AACA;;AAEA;;AAEA;;AACA;;AACA;;AAGA;;AAEA,MAAMA,gBAAgB,GACpBC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAA0B,aAA1B,IACA,CAAC,CAACF,OAAO,CAACC,GAAR,CAAYE,8BAFhB;AAIA,MAAMC,eAAe,GACnBJ,OAAO,CAACC,GAAR,CAAYI,WAAZ,KAA6B,SAA7B,IACAL,OAAO,CAACC,GAAR,CAAYI,WAAZ,KAA6B,sBAD7B,IAEA,CAAC,CAACL,OAAO,CAACC,GAAR,CAAYK,iBAHhB,C,CAKA;AACA;;AACO,MAAMC,aAAa,GAAG,MAAeR,gBAAgB,IAAIK,eAAzD;;;AA4BP,IAAII,YAAJ;;AAEA,MAAMC,eAAe,GAAG,MAAc;EACpC,IAAI,CAACD,YAAL,EAAmB;IACjB,MAAM;MAAEE;IAAF,IACJC,cAAA,CAAMC,QAAN,GAAiBC,SAAjB,CAA2BC,aAA3B,CAAyCC,MAD3C;;IAGAP,YAAY,GAAG,IAAIQ,eAAJ,CAAW;MACxBC,WAAW,EAAEP,yBADW;MAExBQ,yBAAyB,EAAE;IAFH,CAAX,CAAf;EAID;;EAED,OAAOV,YAAP;AACD,CAZD,C,CAcA;AACA;;;AACA,MAAMW,mCAAmC,GAAIC,EAAD,IAAyB;EACnE,IAAI,CAACA,EAAL,EAAS;IACP,OAAO,KAAP;EACD;;EAED,MAAMC,iBAAiB,GACrBV,cAAA,CAAMC,QAAN,GAAiBU,YAAjB,CAA8BC,wBADhC;;EAGA,MAAMC,4BAA4B,GAAG,CAAC,EAACH,iBAAD,aAACA,iBAAD,eAACA,iBAAiB,CAAGD,EAAH,CAAlB,CAAtC;EAEA,OAAOI,4BAAP;AACD,CAXD;AAaA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,MAAMC,8BAA8B,GAAG,OAAO;EAC5CC,WAD4C;EAE5CC;AAF4C,CAAP,KAMlB;EACnB,IAAI,CAACD,WAAW,CAACE,OAAjB,EAA0B;IACxB;EACD;;EAED,MAAMC,iBAAiB,GAAGC,aAAA,CAAKC,IAAL,CACxB/B,OAAO,CAACgC,GAAR,EADwB,EAEvB,kBAFuB,EAGxBL,QAAQ,CAACG,IAHe,CAA1B;;EAMA,MAAMG,gBAAA,CAAGC,SAAH,CAAaL,iBAAb,CAAN;;EAEA,MAAMM,YAAY,GAAGL,aAAA,CAAKC,IAAL,CAAUF,iBAAV,EAA8B,gBAA9B,CAArB;;EAEA,MAAMO,cAAc,GAAG,MAAMH,gBAAA,CAAGI,UAAH,CAAcF,YAAd,CAA7B;;EAEA,IAAI,CAACC,cAAL,EAAqB;IACnB,MAAMH,gBAAA,CAAGK,SAAH,CAAaH,YAAb,EAA2B;MAC/BP,OAAO,EAAEF,WAAW,CAACE;IADU,CAA3B,CAAN;EAGD;AACF,CA5BD;;AA2CA,MAAMW,2BAA2B,GAC/B,CAAC;EACCb,WADD;EAECc;AAFD,CAAD,KAOA,OAAO;EACLC,UADK;EAELd,QAFK;EAGLe,OAHK;EAILC,MAJK;EAKLC,eALK;EAMLC;AANK,CAAP,KAO4C;EAAA;;EAC1C,IAAIF,MAAM,KAAM,iBAAhB,EAAkC;IAChC;IACA;IACA;IACA,MAAMlB,8BAA8B,CAAC;MAAEC,WAAF;MAAeC;IAAf,CAAD,CAApC;EACD;;EAED,MAAMmB,aAAa,GAAGD,KAAK,SAAL,IAAAA,KAAK,WAAL,IAAAA,KAAK,CAAEE,OAAP,GACjB,GAAEL,OAAQ,OAAMG,KAAK,CAACE,OAAQ,EADb,GAElBL,OAFJ;EAIA,MAAM;IAAEM;EAAF,IAAW,MAAM,IAAAC,qBAAA,EAAa;IAClCC,GAAG,EAAEN,eAD6B;IAElCO,KAAK;IAAE;IAAe;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAVwC;IAWlCC,SAAS,EAAE;MACTC,KAAK,EAAE;QACLC,gBAAgB,EAAG,mBADd;QAELC,QAAQ,EAAEd,UAAF,aAAEA,UAAF,uBAAEA,UAAU,CAAEc,QAFjB;QAGLC,QAAQ,EAAE7B,QAAF,aAAEA,QAAF,uBAAEA,QAAQ,CAAEG,IAHf;QAIL2B,gBAAgB,EACd/B,WAAW,CAAC+B,gBAAZ,IAAgC/B,WAAW,CAACgC,iBALzC;QAK4D;QACjEf,MANK;QAOLG;MAPK;IADE,CAXuB;IAsBlCa,YAAY,EAAG,4DAtBmB;IAuBlCC,yBAAyB,EAAE,IAvBO;IAwBlCC,OAAO,EAAE;MACPC,eAAe,EAAEpC,WAAW,CAACqC,KADtB;MAEPC,mBAAmB,EAAEtC,WAAW,CAACuC;IAF1B;EAxByB,CAAb,CAAvB;;EA8BA,IAAIjB,IAAJ,aAAIA,IAAJ,wCAAIA,IAAI,CAAEkB,2BAAV,kDAAI,sBAAmCC,OAAvC,EAAgD;IAC9C3B,QAAQ,CAAC4B,GAAT,CACE,IAAAC,kCAAA,EACG,2DAA0D3C,WAAW,CAACN,EAAG,WAAUsB,OAAQ,EAD9F,CADF;EAKD,CAND,MAMO;IACLF,QAAQ,CAAC4B,GAAT,CACE,IAAAC,kCAAA,EACG,mCAAkC3C,WAAW,CAACN,EAAG,mBAAkBsB,OAAQ,oDAD9E,CADF;EAKD;AACF,CAtEH;AAwEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,MAAM4B,aAAa,GAAG,OAAO;EAClC5C,WADkC;EAElCc,QAFkC;EAGlC+B;AAHkC,CAAP,KAQR;EAAA;;EACnB,IAAIpD,mCAAmC,CAACO,WAAD,aAACA,WAAD,uBAACA,WAAW,CAAEN,EAAd,CAAvC,EAA0D;IACxD;EACD;;EAED,MAAMoD,kBAAkB,GAAG,CACxB,mBADwB,EAExB,IAFwB,EAGxB,OAHwB,EAIxB,WAJwB,EAKxB,kBALwB,EAMxB,UANwB,EAOxB,gBAPwB,CAA3B;EAUA,MAAMC,iBAAiB,GAAGD,kBAAkB,CAACE,MAAnB,CACxBC,QAAQ,IAAI,EAAEA,QAAQ,IAAIjD,WAAd,CADY,CAA1B;;EAIA,IAAI,CAACA,WAAD,IAAgB+C,iBAAiB,CAACG,MAAtC,EAA8C;IAC5CpC,QAAQ,CAACqC,IAAT,CACE,IAAAR,kCAAA,EACG,oFADH,CADF;IAKA7B,QAAQ,CAACsC,IAAT,CACE,IAAAT,kCAAA,EACG,yBAAwBU,IAAI,CAACC,SAAL,CAAeP,iBAAf,EAAkC,IAAlC,EAAwC,CAAxC,CAA2C,EADtE,CADF;IAKAjC,QAAQ,CAAC4B,GAAT,CACE,IAAAC,kCAAA,EAAkB,kBAAiBU,IAAI,CAACC,SAAL,CAAetD,WAAf,EAA4B,IAA5B,EAAkC,CAAlC,CAAqC,EAAxE,CADF;IAGA;EACD;;EAED,MAAM,IAAAuD,iCAAA,GAAN;EAEA,MAAMC,iBAAiB,GAAG3C,2BAA2B,CAAC;IACpDb,WADoD;IAEpDc;EAFoD,CAAD,CAArD,CAtCmB,CA2CnB;EACA;;EACA7B,cAAA,CAAMwE,QAAN,CAAe7D,YAAf,CAA4B8D,mCAA5B,CAAgE;IAC9DC,MAAM,EAAE3D,WAAW,CAACN,EAD0C;IAE9DmC,QAAQ,EAAE7B,WAAW,CAAC6B,QAFwC;IAG9D2B;EAH8D,CAAhE;;EAMA,MAAM;IAAEI;EAAF,IAAW,MAAM,IAAAC,gCAAA,EAAyB;IAC9CC,UAAU,EAAG,SADiC;IAE9C,GAAG9D,WAF2C;IAG9C+D,eAAe,EAAE/D,WAAW,CAAC+B,gBAHiB;IAI9CiC,SAAS,EAAE;EAJmC,CAAzB,CAAvB;;EAOA,IACEhE,WAAW,SAAX,IAAAA,WAAW,WAAX,6BAAAA,WAAW,CAAEiE,WAAb,wEAA0Bf,MAA1B,IACC,6BAAD,IAAiCL,OADjC,IAEAe,IAHF,EAIE;IACA5D,WAAW,CAACiE,WAAZ,CAAwBC,OAAxB,CAAgCC,UAAU,IAAI;MAC5CtB,OAAO,CAACuB,2BAAR,CAAoC;QAClCD,UADkC;QAElCP;MAFkC,CAApC;IAID,CALD;EAMD;AACF,CA9EM;AAgFP;AACA;AACA;AACA;AACA;;;;;AACO,MAAMS,cAAc,GAAG,MAAOC,OAAP,IAAiD;EAC7E,MAAM;IAAEC,WAAF;IAAezD,QAAf;IAAyB+B;EAAzB,IAAqCyB,OAA3C;EACA,MAAM;IACJE,KAAK,EAAE;MAAEC,OAAO,EAAEC;IAAX,CADH;IAEJlD;EAFI,IAGF,IAAAmD,8BAAA,GAHJ,CAF6E,CAO7E;EACA;;EACA,IAAIJ,WAAW,CAACK,SAAhB,EAA2B;IACzB;IACA,MAAM;MAAEC,QAAQ,EAAEC;IAAZ,IAAiCC,YAAA,CAAQC,KAAR,CAAcxD,GAAd,CAAvC;;IACA,MAAM;MAAEqD,QAAQ,EAAEI;IAAZ,IAA+BF,YAAA,CAAQC,KAAR,CAAcT,WAAW,CAACK,SAA1B,CAArC;;IAEA,IAAIE,gBAAgB,KAAKG,cAAzB,EAAyC;MACvC,MAAMzB,iBAAiB,GAAG3C,2BAA2B,CAAC;QACpDb,WAAW,EAAEuE,WADuC;QAEpDzD;MAFoD,CAAD,CAArD;MAKA,MAAM0C,iBAAiB,CAAC;QACtBvC,MAAM,EAAG,sCADa;QAEtBD,OAAO,EAAG,sDAFY;QAGtBD,UAAU,EAAE;UACVc,QAAQ,EAAE0C,WAAW,CAAC1C,QADZ;UAEVqD,UAAU,EAAEX,WAAW,CAACxC;QAFd,CAHU;QAOtBb,eAAe,EAAEqD,WAAW,CAACK;MAPP,CAAD,CAAvB;MAUA9D,QAAQ,CAACqC,IAAT,CACE,IAAAR,kCAAA,EACG,4MAA2MwC,cAAA,CAAMC,IAAN,CACzM,aADyM,CAE1M,IAAGb,WAAW,CAACK,SAAU,MAAKO,cAAA,CAAMC,IAAN,CAC7B,qBAD6B,CAE9B,IAAG5D,GAAI,MALX,CADF;MAUA;IACD;EACF;;EAED,MAAM6D,kBAAkB,GACtBX,wBAAwB,IAAIpG,OAAO,CAACC,GAAR,CAAY+G,uBAD1C;;EAGA,IAAID,kBAAJ,EAAwB;IACtBvE,QAAQ,CAACsC,IAAT,CAAe,8CAAf;IACA,IAAAmC,YAAA,EAAKhB,WAAL;EACD;;EAED,MAAMiB,wCAAwC,GAC5C,MAAM,IAAAC,+DAAA,EAAwC;IAC5CC,QAAQ,EAAG,mBADiC;IAE5CC,SAAS,EAAG;EAFgC,CAAxC,CADR;EAMA,MAAMC,cAAc,GAAG,MAAM,IAAAC,yCAAA,EAAqB;IAChDC,iBAAiB,EAAG,sBAD4B;IAEhDC,YAAY,EAAG,eAFiC;IAGhD5D,OAAO,EAAE;MACPC,eAAe,EAAEmC,WAAW,CAAClC,KADtB;MAEPC,mBAAmB,EAAEiC,WAAW,CAAChC;IAF1B,CAHuC;IAOhD+B,OAPgD;IAQhD7C,KAAK;IAAE;IAAe;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA,8BACc;IACA;IACAuE,IAAI,CAACC,GAAL,KAAa,OAAO,EAAP,GAAY,EAC1B;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgBT,wCAAwC,GAAI,aAAJ,GAAoB,EAAE;AAC9E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EA3CoD,CAArB,CAA7B;;EA8CA,IAAI,EAACI,cAAD,aAACA,cAAD,eAACA,cAAc,CAAE1C,MAAjB,CAAJ,EAA6B;IAC3B,IAAImC,kBAAJ,EAAwB;MACtBvE,QAAQ,CAACsC,IAAT,CACG,kBAAiBmB,WAAlB,aAAkBA,WAAlB,uBAAkBA,WAAW,CAAE7E,EAAG,sCADpC;IAGD;;IACD;EACD;;EAED,IAAI2F,kBAAJ,EAAwB;IACtBvE,QAAQ,CAACsC,IAAT,CACG,kBAAiBmB,WAAlB,aAAkBA,WAAlB,uBAAkBA,WAAW,CAAE7E,EAAG,kCADpC;IAGA,IAAA6F,YAAA,EAAKK,cAAL;EACD;;EAED,MAAMM,KAAK,GAAGnH,eAAe,EAA7B;;EAEA,KAAK,MAAM;IAAEiB;EAAF,CAAX,IAA8B4F,cAA9B,EAA8C;IAC5CM,KAAK,CAACC,GAAN,CAAU,MACRvD,aAAa,CAAC;MACZ5C,WAAW,EAAE,EAAE,GAAGA,WAAL;QAAkBqC,KAAK,EAAEkC,WAAW,CAAClC;MAArC,CADD;MAEZvB,QAFY;MAGZ+B;IAHY,CAAD,CADf;EAOD;;EAED,MAAMuD,OAAO,CAACC,GAAR,CAAY,CAACH,KAAK,CAACI,OAAN,EAAD,EAAkBJ,KAAK,CAACK,MAAN,EAAlB,CAAZ,CAAN,CApI6E,CAsI7E;;EACA,MAAM,IAAAC,iDAAA,EAAyC;IAC7CvF,MAAM,EAAG,8BADoC;IAE7CD,OAAO,EAAG;EAFmC,CAAzC,CAAN;AAID,CA3IM"}